# VideoPlayer 實作說明

本文件詳細說明 WinUI 3 VideoPlayer 專案的實作細節與架構設計。

## 專案概述

VideoPlayer 是一個類似 YouTube 風格的本地影片瀏覽與播放應用程式，使用 WinUI 3 開發，遵循 MVVM 架構模式。

## 技術架構

### 核心技術棧
- **UI 框架**: WinUI 3 (Windows App SDK 1.6)
- **開發平台**: .NET 10.0
- **設計模式**: MVVM (Model-View-ViewModel)
- **MVVM 工具**: CommunityToolkit.Mvvm
- **影片處理**: FFMpegCore
- **目標平台**: Windows 10 (1809+) / Windows 11

### 專案結構

```
VideoPlayer/
├── App.xaml                           # 應用程式定義
├── App.xaml.cs                        # 應用程式啟動邏輯
├── MainWindow.xaml                    # 主視窗 UI
├── MainWindow.xaml.cs                 # 主視窗邏輯（導航控制）
├── app.manifest                       # 應用程式資訊清單
├── VideoPlayer.csproj                 # 專案檔
│
├── Models/                            # 資料模型
│   └── VideoItem.cs                   # 影片項目模型
│
├── Views/                             # 視圖層
│   ├── VideoGalleryPage.xaml         # 影片畫廊頁面 UI
│   ├── VideoGalleryPage.xaml.cs      # 影片畫廊頁面邏輯
│   ├── VideoPlayerPage.xaml          # 影片播放頁面 UI
│   └── VideoPlayerPage.xaml.cs       # 影片播放頁面邏輯
│
├── ViewModels/                        # 視圖模型層
│   ├── VideoGalleryViewModel.cs      # 畫廊頁面視圖模型
│   └── VideoPlayerViewModel.cs       # 播放器頁面視圖模型
│
├── Services/                          # 服務層
│   ├── VideoScannerService.cs        # 影片掃描服務
│   └── ThumbnailService.cs           # 縮圖生成服務
│
└── Assets/                            # 資源檔案
    ├── Icons/                         # 應用程式圖示
    ├── Images/                        # 圖片資源
    └── README.md                      # 資源說明
```

## 核心功能實作

### 1. 資料模型 (Models)

#### VideoItem.cs
影片項目的資料模型，使用 `ObservableObject` 實現屬性變更通知。

**主要屬性**:
- `FilePath`: 影片檔案完整路徑
- `Name`: 顯示名稱
- `Duration`: 影片時長
- `FileSize`: 檔案大小（位元組）
- `ThumbnailPath`: 縮圖路徑
- `FormattedFileSize`: 格式化的檔案大小（例如："1.5 GB"）
- `FormattedDuration`: 格式化的時長（例如："1:23:45"）

**特色**:
- 使用 `[ObservableProperty]` 特性自動生成屬性變更通知程式碼
- 提供計算屬性用於顯示格式化資料

### 2. 服務層 (Services)

#### VideoScannerService.cs
負責掃描資料夾並識別影片檔案。

**主要功能**:
- `ScanFolderAsync()`: 非同步掃描指定資料夾
  - 支援遞迴掃描子資料夾
  - 過濾支援的影片格式
  - 安全處理檔案存取錯誤
  
- `GetVideoMetadataAsync()`: 使用 FFmpeg 取得影片中繼資料
  - 取得影片時長
  - 錯誤處理：無法讀取時設定預設值

**支援格式**:
MP4, MKV, AVI, WMV, MOV, FLV, WEBM, M4V, MPG, MPEG, 3GP

#### ThumbnailService.cs
負責生成和管理影片縮圖。

**主要功能**:
- `GenerateThumbnailAsync()`: 為影片生成縮圖
  - 使用 FFmpeg 擷取影片畫面（影片 10% 位置或 5 秒處）
  - 縮圖尺寸: 320x180 像素
  - 智慧快取：避免重複生成
  
- `ClearCache()`: 清除縮圖快取

**快取機制**:
- 快取位置: `%TEMP%\VideoPlayerThumbnails\`
- 使用檔案路徑雜湊值作為快取檔名
- 持久化快取，加速後續載入

### 3. 視圖模型 (ViewModels)

#### VideoGalleryViewModel.cs
畫廊頁面的業務邏輯與狀態管理。

**屬性**:
- `Videos`: 影片集合（ObservableCollection）
- `SelectedVideo`: 當前選中的影片
- `CurrentFolderPath`: 當前資料夾路徑
- `IsLoading`: 載入狀態指示
- `StatusMessage`: 狀態訊息

**命令**:
- `SelectFolderCommand`: 開啟資料夾選擇器
- `RefreshCommand`: 重新整理當前資料夾
- `ClearCacheCommand`: 清除縮圖快取

**特色實作**:
- **批次載入**: 每次載入 10 個影片，避免 UI 凍結
- **平行處理**: 使用 `Task.WhenAll` 平行處理中繼資料和縮圖
- **錯誤處理**: 優雅處理掃描和載入錯誤
- **進度回饋**: 即時更新載入進度

#### VideoPlayerViewModel.cs
播放器頁面的狀態管理。

**屬性**:
- `CurrentVideo`: 當前播放的影片
- `IsPlaying`: 播放狀態
- `Volume`: 音量（0.0 - 1.0）
- `IsMuted`: 靜音狀態
- `CurrentPosition`: 當前播放位置
- `PlaybackRate`: 播放速度

**命令**:
- `TogglePlayPauseCommand`: 切換播放/暫停
- `ToggleMuteCommand`: 切換靜音
- `SeekForwardCommand`: 快進（預設 10 秒）
- `SeekBackwardCommand`: 倒退（預設 10 秒）
- `ChangePlaybackSpeedCommand`: 調整播放速度

### 4. 視圖層 (Views)

#### VideoGalleryPage.xaml
YouTube 風格的影片畫廊介面。

**UI 組成**:
1. **工具列** (CommandBar):
   - 選擇資料夾按鈕
   - 重新整理按鈕
   - 清除快取按鈕

2. **影片網格** (GridView):
   - 縮圖顯示（320x180）
   - 影片資訊卡片
   - 時長標籤（右下角）
   - 檔案大小顯示

3. **狀態列**:
   - 狀態訊息
   - 載入進度指示器

**資料綁定**:
- 使用 `x:Bind` 編譯時綁定，提升效能
- 自訂值轉換器：
  - `StringToUriConverter`: 字串路徑轉 URI
  - `NullToVisibilityConverter`: 空值轉可見性
  - `TimeSpanToVisibilityConverter`: 時長轉可見性

**互動設計**:
- 點擊縮圖卡片開啟播放頁面
- 滾動載入大量影片
- 回應式佈局

#### VideoPlayerPage.xaml
影片播放介面。

**UI 組成**:
1. **導航列**:
   - 返回按鈕
   - 影片標題

2. **播放器** (MediaPlayerElement):
   - 全螢幕支援
   - 內建播放控制條
   - 進度條
   - 音量控制
   - 播放速度調整
   - 縮放功能

3. **載入指示器**:
   - 影片載入時顯示進度環

**播放功能**:
- 自動播放
- 完整的傳輸控制
- 錯誤處理與提示對話框
- 離開頁面時自動停止播放

#### VideoGalleryPage.xaml.cs
畫廊頁面的程式碼後置。

**核心功能**:
- 初始化 ViewModel
- 設定視窗控制代碼（用於檔案選擇器）
- 處理影片項目點擊事件
- 導航到播放器頁面

**輔助類別**:
- `WindowHelper`: 從 UI 元素取得視窗物件
- 值轉換器實作

#### VideoPlayerPage.xaml.cs
播放器頁面的程式碼後置。

**核心功能**:
- 接收導航參數（VideoItem）
- 載入並播放影片
- 處理媒體事件：
  - MediaOpened: 影片開啟成功
  - MediaFailed: 播放失敗處理
- 清理資源：離開頁面時釋放媒體播放器

### 5. 應用程式進入點

#### App.xaml.cs
應用程式生命週期管理。

**功能**:
- 初始化應用程式
- 建立主視窗
- 啟動應用程式

#### MainWindow.xaml.cs
主視窗與導航控制。

**功能**:
- 設定視窗大小（1280x720）
- 初始化導航框架
- 預設導航到畫廊頁面
- 處理導航選單選擇

## MVVM 架構實踐

### 資料綁定
- **雙向綁定**: 使用 `Mode=TwoWay` 實現使用者輸入
- **單向綁定**: 使用 `Mode=OneWay` 顯示資料
- **編譯時綁定**: 使用 `x:Bind` 提升效能並實現型別安全

### 命令模式
使用 CommunityToolkit.Mvvm 的 `[RelayCommand]` 特性：
- 自動生成 ICommand 實作
- 支援非同步命令
- 簡化命令參數傳遞

### 屬性通知
使用 `[ObservableProperty]` 特性：
- 自動生成屬性變更通知
- 減少樣板程式碼
- 提升程式碼可讀性

## 效能最佳化

### 1. 批次載入
- 每次載入 10 個影片項目
- 避免一次性載入大量資料造成 UI 卡頓

### 2. 平行處理
- 使用 `Task.WhenAll` 平行處理中繼資料和縮圖
- 最大化 CPU 利用率

### 3. 縮圖快取
- 持久化快取到磁碟
- 避免重複生成縮圖
- 大幅提升重複瀏覽效能

### 4. 異步操作
- 所有 I/O 操作都是非同步的
- 保持 UI 回應性

### 5. 記憶體管理
- 離開頁面時釋放媒體播放器資源
- 使用弱參考避免記憶體洩漏

## 錯誤處理策略

### 1. 檔案存取錯誤
- 使用 try-catch 包裝檔案操作
- 跳過無法存取的檔案
- 繼續處理其他檔案

### 2. 影片載入失敗
- 顯示友善的錯誤對話框
- 提供錯誤訊息
- 允許使用者返回畫廊

### 3. 縮圖生成失敗
- 靜默處理失敗
- 顯示預設圖示
- 不中斷使用者體驗

### 4. FFmpeg 錯誤
- 優雅降級：無法取得中繼資料時設定預設值
- 記錄錯誤但不中斷流程

## 使用者體驗設計

### 1. 載入回饋
- 即時狀態訊息
- 進度指示器
- 載入完成通知

### 2. 視覺設計
- Fluent Design System
- 符合 Windows 11 設計語言
- 暗色/亮色主題支援（系統自動）

### 3. 互動流程
1. 啟動應用程式 → 顯示空白畫廊
2. 點擊「選擇資料夾」→ 開啟資料夾選擇器
3. 選擇資料夾 → 自動掃描並顯示影片
4. 點擊縮圖 → 進入播放頁面
5. 點擊返回 → 回到畫廊

### 4. 效能感知
- 批次載入降低初始載入時間
- 快取機制加速重複瀏覽
- 背景處理不阻塞 UI

## 擴充性設計

### 易於擴充的點

1. **新增影片格式**:
   - 修改 `VideoScannerService._supportedExtensions`

2. **自訂縮圖設定**:
   - 修改 `ThumbnailService.GenerateThumbnailAsync()`

3. **新增頁面**:
   - 在 Views 資料夾建立新 XAML 頁面
   - 在 ViewModels 建立對應 ViewModel
   - 在 MainWindow 新增導航項目

4. **整合雲端服務**:
   - 在 Services 新增雲端服務類別
   - 實作檔案上傳/下載

5. **播放清單功能**:
   - 新增 Playlist 模型
   - 建立播放清單管理服務
   - 新增播放清單 UI 頁面

## 已知限制與未來改進

### 目前限制
1. **Windows 專屬**: 無法在 Linux/macOS 執行
2. **本地檔案**: 不支援網路串流
3. **編解碼器**: 依賴 Windows Media Foundation
4. **單一語言**: 目前僅支援系統語言

### 未來改進方向
1. 播放清單支援
2. 影片中繼資料編輯
3. 字幕支援
4. 搜尋與篩選功能
5. 標籤與分類系統
6. 多語言支援
7. 自訂主題
8. 影片轉檔工具整合

## 開發建議

### 程式碼風格
- 遵循 C# 編碼慣例
- 使用有意義的命名
- 適當的程式碼註解
- XML 文件註解

### 測試建議
1. 單元測試：Services 和 ViewModels
2. 整合測試：頁面導航流程
3. UI 測試：使用 WinAppDriver

### 效能測試
- 測試大量影片（1000+）的載入效能
- 記憶體洩漏檢測
- 縮圖生成效能

## 除錯技巧

### Visual Studio 除錯
1. 設定中斷點
2. 使用即時視窗
3. 檢視 XAML 即時視覺化樹狀結構

### 常見問題
1. **綁定失敗**: 檢查輸出視窗的綁定錯誤
2. **導航問題**: 確認 Frame 和 Page 正確設定
3. **資源未找到**: 檢查 Build Action 設定

## 部署

### 開發部署
- F5 直接執行
- 不需要封裝

### 生產部署
- 建立 MSIX 套件
- 程式碼簽章
- 透過 Microsoft Store 或側載分發

## 結語

VideoPlayer 專案展示了如何使用 WinUI 3 和現代 .NET 技術建立桌面應用程式。透過 MVVM 架構，程式碼結構清晰、易於維護和擴充。專案遵循 Windows 平台的最佳實踐，提供流暢的使用者體驗。
