# 使用指南 / Usage Guide

## 快速開始

### 1. 安裝 FFmpeg

影片下載和轉檔需要 FFmpeg：

**Windows:**
```powershell
# 使用 winget
winget install Gyan.FFmpeg

# 或使用 Chocolatey
choco install ffmpeg
```

**Linux (Ubuntu/Debian):**
```bash
sudo apt install ffmpeg
```

**macOS:**
```bash
brew install ffmpeg
```

### 2. 建置專案

```bash
cd HentaiDownloader
dotnet build
```

### 3. 執行程式

```bash
dotnet run --project HentaiDownloader
```

## 使用模式

### 模式 1：直接輸入影片 URL

適用於已知影片直接連結的情況（M3U8、MP4、TS 等）

```
=== 影片下載器 / ビデオダウンローダー ===
支援 / サポート: M3U8, MP4, TS 等格式
支援從網頁自動提取影片連結

請選擇模式:
  1. 直接輸入影片 URL (M3U8/MP4/TS)
  2. 輸入網頁 URL，自動提取影片連結
請選擇 (1 或 2): 1
請輸入影片 URL: https://example.com/video.m3u8
請輸入輸出檔案名稱 (不含副檔名，支援中文/日文/空格): 測試影片

偵測到 M3U8 連結...
正在下載 M3U8...
找到 150 個片段
使用 10 個並行下載
下載進度: 150/150 (100.0%) | 速度: 8.5 片段/秒 | 剩餘: 0 秒
下載完成! 耗時: 17.6 秒
正在合併片段並轉換為 MP4...
✅ 下載完成: /path/to/影片/測試影片.mp4
```

### 模式 2：從網頁提取影片 URL

適用於影片嵌入在網頁中的情況

```
請選擇模式:
  1. 直接輸入影片 URL (M3U8/MP4/TS)
  2. 輸入網頁 URL，自動提取影片連結
請選擇 (1 或 2): 2
請輸入網頁 URL: https://example.com/watch/12345

正在下載瀏覽器 (首次執行需要較長時間)...
正在啟動瀏覽器...
正在載入網頁: https://example.com/watch/12345
等待頁面渲染...
嘗試觸發影片播放...
正在搜尋 video 標籤...

找到影片連結: https://cdn.example.com/video.m3u8
請輸入輸出檔案名稱 (不含副檔名，支援中文/日文/空格): 我的影片

偵測到 M3U8 連結...
[下載過程...]
✅ 下載完成: /path/to/影片/我的影片.mp4
```

## 功能說明

### 自動格式轉換

下載非 MP4 格式的影片時，程式會自動提示轉換：

```
✅ 下載完成: /path/to/影片/video.ts

正在轉換為 MP4 格式...
✅ 轉換完成: /path/to/影片/video.mp4
是否刪除原始檔案? (Y/N): Y
已刪除原始檔案
```

### M3U8 加密處理

程式自動處理 AES-128 加密的 M3U8 串流：

```
偵測到 AES-128 加密，正在下載金鑰...
金鑰下載完成 (16 bytes)
下載進度: 150/150 (100.0%) | 速度: 8.5 片段/秒 | 剩餘: 0 秒
```

### 網頁影片提取策略

程式使用多種策略來尋找影片：

1. **網路請求監聽**：攔截所有含有 `.m3u8`、`.mp4` 等副檔名的請求
2. **Content-Type 檢查**：檢查回應的 Content-Type 是否為影片類型
3. **JavaScript API 攔截**：注入代碼攔截 XMLHttpRequest、fetch、MediaSource
4. **DOM 解析**：從 `<video>` 和 `<source>` 標籤提取 src 屬性
5. **Script 搜尋**：在 `<script>` 標籤中搜尋影片 URL
6. **iframe 處理**：自動進入 iframe 繼續搜尋

### 下載模式

#### 分段並行下載（支援 Range 請求）
```
檔案大小: 150.00 MB
使用分段下載模式...
分成 75 個區塊下載 (每塊 2.00 MB)
使用 10 個並行下載
下載進度: 150.00 MB/150.00 MB (100.0%) | 區塊: 75/75 | 速度: 5.2 MB/s | 剩餘: 0 秒
```

#### 串流下載（不支援 Range）
```
使用串流下載模式...
下載進度: 45.2 MB/150.0 MB (30.1%) | 速度: 2.3 MB/s | 剩餘: 46 秒
```

## 疑難排解

### FFmpeg 未安裝

```
錯誤: 找不到 FFmpeg，請先安裝 FFmpeg 並加入 PATH 環境變數
下載位址: https://ffmpeg.org/download.html
```

**解決方案**：
1. 按照上述方法安裝 FFmpeg
2. 確認 FFmpeg 已加入 PATH：`ffmpeg -version`
3. Windows 使用者可能需要重啟終端機或電腦

### 找不到影片連結

```
未找到任何影片連結
```

**可能原因**：
1. 網頁需要登入才能觀看影片
2. 影片使用特殊的播放器或 DRM 保護
3. 網頁載入時間過長，需要調整等待時間

**解決方案**：
- 嘗試使用模式 1 直接輸入影片 URL（可以從瀏覽器開發者工具的網路標籤中找到）
- 確認網頁可以在正常瀏覽器中播放影片

### 下載失敗

```
下載失敗: The operation was canceled.
```

**可能原因**：
1. 網路連線不穩定
2. 伺服器拒絕連線
3. URL 已過期

**解決方案**：
- 檢查網路連線
- 重新取得影片 URL（某些 URL 有時效限制）
- 嘗試降低並行下載數量（修改 MaxConcurrentDownloads）

## 進階使用

### 自訂並行下載數量

編輯 `DownloadService.cs`：

```csharp
private const int MaxConcurrentDownloads = 10; // 修改此數值
```

建議值：
- 快速網路：10-20
- 一般網路：5-10
- 慢速網路：3-5

### 輸出檔名規則

- 支援中文、日文等 Unicode 字元
- 支援空格
- 自動移除不合法的檔名字元
- 若未輸入檔名，使用時間戳記：`output_20231215_143052`

### 下載位置

所有影片統一儲存在程式執行目錄下的 `影片/` 資料夾中。

## 支援的格式

| 格式 | 下載 | 轉檔 | 說明 |
|------|------|------|------|
| M3U8 (HLS) | ✅ | ✅ | 自動合併為 MP4 |
| MP4 | ✅ | - | 直接下載 |
| TS | ✅ | ✅ | 可轉換為 MP4 |
| WebM | ✅ | ✅ | 可轉換為 MP4 |
| FLV | ✅ | ✅ | 可轉換為 MP4 |
| MPD (DASH) | ⚠️ | - | 需額外處理 |

## 效能優化建議

1. **SSD 優於 HDD**：暫存檔案會頻繁讀寫
2. **充足記憶體**：並行下載會佔用較多記憶體
3. **穩定網路**：避免使用 Wi-Fi，建議有線連接
4. **關閉防毒軟體的即時掃描**：避免影響檔案寫入效能

## 法律聲明

- 本工具僅供學習和研究使用
- 請尊重版權，不要下載受版權保護的內容
- 使用者需自行承擔使用本工具的法律責任
